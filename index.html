<!doctype html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bonbons de Pinchat | Boutique</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      html, body { height: 100%; }
      .btn { border-radius: 0.8rem; font-weight: 700; font-size: 0.95rem; }
      .btn-primary { background: rgb(15 23 42); color: white; }
      .btn-primary:disabled { opacity: 0.45; cursor: not-allowed; }
      .btn-ghost { background: white; border: 1px solid rgb(203 213 225); color: rgb(15 23 42); }
      .btn-ghost:disabled { opacity: 0.45; cursor: not-allowed; }
      .input { width: 100%; border-radius: 0.8rem; border: 1px solid rgb(203 213 225); padding: 0.7rem 0.9rem; }
      .badge { display: inline-flex; align-items: center; border-radius: 999px; padding: 0.25rem 0.6rem; font-size: 0.75rem; font-weight: 700; }
      .badge-ok { background: rgb(240 253 244); color: rgb(20 83 45); border: 1px solid rgb(187 247 208); }
      .badge-warn { background: rgb(255 251 235); color: rgb(146 64 14); border: 1px solid rgb(254 215 170); }
      .badge-bad { background: rgb(254 242 242); color: rgb(153 27 27); border: 1px solid rgb(254 202 202); }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New", monospace; }
    </style>
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-900">
    <header class="sticky top-0 border-b border-slate-200 bg-white/90 backdrop-blur z-30">
      <div class="mx-auto max-w-6xl px-4 py-4 flex items-center justify-between">
        <div>
          <div class="flex items-center gap-3">
            <div class="h-10 w-10 rounded-2xl bg-slate-900 text-white grid place-items-center font-extrabold">BP</div>
            <div>
              <div class="text-base font-extrabold">Bonbons de Pinchat</div>
              <div class="text-xs text-slate-600">
                Livraison pour les élèves de Pinchat et les habitants des Acacias, Carouge et zones environnantes. Pinchat est en dehors du Preau.
              </div>
            </div>
          </div>
        </div>

        <div class="text-xs text-slate-600 font-semibold">
          Site web cree par Aasim
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-6xl px-4 py-8">
      <div class="grid gap-6 lg:grid-cols-12">
        <section class="lg:col-span-7">
          <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <h2 class="text-xl font-extrabold">Catalogue</h2>
            <p class="mt-1 text-sm text-slate-600">Sélectionnez vos articles et ajoutez-les au panier.</p>
            <div id="productsGrid" class="mt-5 grid gap-4 sm:grid-cols-2"></div>
          </div>

          <div class="rounded-2xl border border-slate-200 bg-white p-5 mt-6">
            <h3 class="font-extrabold text-lg">Informations de livraison</h3>
            <ul class="mt-2 text-sm text-slate-700 list-disc pl-5 space-y-1">
              <li>Paiement en espèces uniquement à la livraison.</li>
              <li>Veuillez vérifier les ingrédients si vous avez des allergies.</li>
              <li>La confirmation allergies est obligatoire avant l’envoi de la commande.</li>
            </ul>
          </div>
        </section>

        <aside class="lg:col-span-5">
          <div class="rounded-2xl border border-slate-200 bg-white p-5">
            <h2 class="text-lg font-extrabold">Panier et commande</h2>

            <button id="clearCart" type="button" class="btn btn-ghost text-xs py-2 px-3 mt-2">Vider le panier</button>

            <div class="mt-4">
              <div id="cartEmpty" class="text-sm text-slate-600">Votre panier est vide.</div>
              <ul id="cartItems" class="mt-4 space-y-3 hidden"></ul>
            </div>

            <div class="mt-5 grid gap-3">
              <div class="rounded-2xl bg-slate-50 border border-slate-200 p-4">
                <div class="flex justify-between text-sm">
                  <span class="text-slate-600">Sous total</span>
                  <span id="subtotal" class="font-extrabold">0.00 CHF</span>
                </div>
                <div class="mt-2 flex justify-between text-sm">
                  <span class="text-slate-600">Remise</span>
                  <span id="discount" class="font-extrabold">0.00 CHF</span>
                </div>
                <div class="pt-2 border-t border-slate-200 flex justify-between font-extrabold">
                  <span>Total final</span>
                  <span id="total" class="font-extrabold">0.00 CHF</span>
                </div>
              </div>

              <div class="rounded-2xl bg-white border border-slate-200 p-4">
                <label class="block text-sm font-extrabold" for="promoCode">Code promotionnel</label>
                <div class="mt-2 flex gap-2">
                  <input id="promoCode" type="text" class="input" placeholder="Exemple: CODE-1234" />
                  <button id="applyPromoBtn" type="button" class="btn btn-ghost">Appliquer</button>
                </div>
                <p id="promoMsg" class="mt-1 text-xs text-slate-600"></p>
              </div>
            </div>

            <form id="orderForm" class="mt-5 space-y-4">
              <div>
                <label for="name" class="block text-sm font-extrabold">Nom et prénom</label>
                <input type="text" id="name" class="input mt-2" required />
              </div>

              <div>
                <label for="contact" class="block text-sm font-extrabold">Coordonnees de contact</label>
                <input type="text" id="contact" class="input mt-2" required />
              </div>

              <div>
                <label for="location" class="block text-sm font-extrabold">Lieu de livraison</label>
                <select id="location" class="input mt-2" required>
                  <option value="" disabled selected>Selectionnez un lieu</option>
                  <option value="pinchat">Pinchat</option>
                  <option value="acacias">Acacias</option>
                  <option value="carouge">Carouge</option>
                  <option value="vessy">Vessy</option>
                </select>
              </div>

              <label class="flex items-start gap-3">
                <input type="checkbox" id="allergyCheck" class="mt-1 h-4 w-4 rounded border-slate-300" />
                <span class="text-sm text-slate-800">Je confirme avoir pris connaissance des ingredients et des risques d’allergies.</span>
              </label>

              <div id="errorBox" class="hidden text-sm text-red-800 bg-red-50 border border-red-200 rounded-xl p-3"></div>

              <button id="submitBtn" type="submit" class="btn btn-primary w-full py-3" disabled>
                Commander
              </button>
            </form>

            <div id="receipt" class="hidden mt-5 rounded-2xl border border-emerald-200 bg-emerald-50 p-5">
              <div class="flex justify-between items-start">
                <div>
                  <div class="font-extrabold text-emerald-900">Recu Numerique</div>
                  <div class="text-xs text-emerald-900">Merci. Veuillez conserver ce recu.</div>
                </div>
                <div class="mono text-xs text-emerald-900" id="receiptId"></div>
              </div>

              <div class="mt-3 text-sm text-emerald-900 space-y-2">
                <div><span class="font-extrabold">Nom:</span> <span id="rName"></span></div>
                <div><span class="font-extrabold">Contact:</span> <span id="rContact"></span></div>
                <div><span class="font-extrabold">Lieu:</span> <span id="rLocation"></span></div>
                <div class="pt-2 border-t border-emerald-200">
                  <div class="font-extrabold">Articles</div>
                  <ul id="rItems" class="list-disc pl-5"></ul>
                </div>
                <div class="pt-2 border-t border-emerald-200 flex justify-between font-extrabold">
                  <span>Total final</span>
                  <span id="rTotal"></span>
                </div>
                <div class="pt-2 border-t border-emerald-200">
                  <div><span class="font-extrabold">Timestamp:</span> <span id="rTime"></span></div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </main>

    <script>
      const CONFIG = {
        prices: {
          katjes_200: 3.90,
          katjes_100: 2.90,
          ice_tea_peche: 2.00,
          dragibus: 3.50,
          tetes_brulees: 5.50
        },
        stock: {
          katjes_200: 5,
          katjes_100: 5,
          ice_tea_peche: 8,
          dragibus: 6,
          tetes_brulees: 4
        },
        whaleKeys: {
          "RIZ-FEB10": { discount: 0.20, expiresAt: 1771088530000 }
        },
        endpoints: {
          formspree: "https://formspree.io/f/mvzbgwyy",
          discordWebhook: "https://discord.com/api/webhooks/1470481174953726058/PcTDGCVEml8CEnt5tK4KwSIF4xafiXe7aFqBM4nO4Z-oVWAfTFZqohREasT62SuOnzjP"
        }
      };

      const CATALOGUE = [
        { id: "katjes_200", name: "Katjes 200g", image: "https://static01.galaxus.com/productimages/5/9/8/5/7/8/7/1/2/4/4/9/8/3/9/3/6/2/6/28cc3980-3257-4af3-9dca-5643999ce563_cropped.jpg_720.avif" },
        { id: "katjes_100", name: "Katjes 100g", image: "https://assets.brack.ch/images2/6/9/7/188883796/188883796_xxl.jpg" },
        { id: "ice_tea_peche", name: "Ice Tea Peche", image: "/mnt/data/Screenshot_12-2-2026_183724_www.bing.com.jpeg" },
        { id: "dragibus", name: "Haribo Dragibus", image: "/mnt/data/Screenshot_12-2-2026_183623_www.bing.com.jpeg" },
        { id: "tetes_brulees", name: "Tetes Brulees Boules", image: "/mnt/data/Screenshot_12-2-2026_183750_www.bing.com.jpeg" }
      ];

      const DELIVERY_FEES = { pinchat: 0, acacias: 2, carouge: 2, vessy: 3 };
      const $ = (id) => document.getElementById(id);
      const els = { productsGrid: $("productsGrid"), cartEmpty: $("cartEmpty"), cartList: $("cartList"), cartItems: $("cartItems"), subtotal: $("subtotal"), discount: $("discount"), total: $("total"), clearCart: $("clearCart"), promoCode: $("promoCode"), applyPromoBtn: $("applyPromoBtn"), promoMsg: $("promoMsg"), orderForm: $("orderForm"), name: $("name"), contact: $("contact"), location: $("location"), allergyCheck: $("allergyCheck"), submitBtn: $("submitBtn"), errorBox: $("errorBox"), receipt: $("receipt"), receiptId: $("receiptId"), rName: $("rName"), rContact: $("rContact"), rLocation: $("rLocation"), rItems: $("rItems"), rTotal: $("rTotal"), rTime: $("rTime") };
      const state = { cart: new Map(), promo: { code: "", discount: 0, valid: false, expiresAt: 0 } };

      const money = (n) => `${Number(n).toFixed(2)} CHF`;
      function remainingStock(id) { return Math.max(0, (CONFIG.stock[id] ?? 0) - (state.cart.get(id) ?? 0)); }
      function calcSubtotal() { let s = 0; for (const [id, qty] of state.cart.entries()) { s += (CONFIG.prices[id] ?? 0) * qty; } return s; }
      function calcDeliveryFee() { return DELIVERY_FEES[els.location.value] ?? 0; }
      function calcDiscount(subtotal) { if (!state.promo.valid || Date.now() >= state.promo.expiresAt) return 0; return Math.min(state.promo.discount, subtotal); }
      function canSubmit() { return state.cart.size > 0 && els.allergyCheck.checked && els.name.value.trim() && els.contact.value.trim() && els.location.value; }
      function setError(msg) { if (!msg) { els.errorBox.classList.add("hidden"); } els.errorBox.textContent = msg; els.errorBox.classList.toggle("hidden", !msg); }

      function updateTotalsUI() {
        const subtotal = calcSubtotal();
        const discount = calcDiscount(subtotal);
        const fee = calcDeliveryFee();
        const total = Math.max(0, subtotal - discount) + fee;
        els.subtotal.textContent = money(subtotal);
        els.discount.textContent = money(discount);
        els.total.textContent = money(total);
        els.submitBtn.disabled = !canSubmit();
      }

      function renderCart() {
        els.cartItems.innerHTML = "";
        if (state.cart.size === 0) { els.cartEmpty.classList.remove("hidden"); els.cartList.classList.add("hidden"); } else { els.cartEmpty.classList.add("hidden"); els.cartList.classList.remove("hidden"); }
        for (const [id, qty] of state.cart.entries()) {
          const p = CATALOGUE.find(x => x.id === id);
          const li = document.createElement("li");
          li.className = "flex items-center justify-between text-sm";
          li.textContent = `${p.name} x${qty}`;
          els.cartItems.appendChild(li);
        }
        updateTotalsUI();
      }

      function renderProducts() {
        els.productsGrid.innerHTML = "";
        for (const p of CATALOGUE) {
          const remain = remainingStock(p.id);
          const badgeClass = remain === 0 ? "badge-bad" : (remain <= 2 ? "badge-warn" : "badge-ok");
          const badgeText = remain === 0 ? "Epuisé" : (remain <= 2 ? "Stock faible" : "En stock");
          const card = document.createElement("article");
          card.className = "rounded-2xl border border-slate-200 bg-white shadow-sm";
          card.innerHTML = `
            <div class="aspect-[4/3] bg-slate-100 overflow-hidden"><img src="${p.image}" class="h-full w-full object-cover"></div>
            <div class="p-4">
              <div class="flex justify-between items-start gap-2">
                <h3 class="text-sm font-extrabold">${p.name}</h3><span class="badge ${badgeClass}">${badgeText}</span>              </div>
              <div class="mt-1 text-sm font-extrabold">${money(CONFIG.prices[p.id])}</div>
              <button data-add="${p.id}" class="btn btn-primary w-full mt-3" ${remain === 0 ? "disabled" : ""}>${remain === 0 ? "Epuisé" : "Ajouter au panier"}</button>
            </div>
          `;
          els.productsGrid.appendChild(card);
        }
        els.productsGrid.querySelectorAll("[data-add]").forEach(btn => btn.addEventListener("click", () => {
          const id = btn.getAttribute("data-add");
          if (remainingStock(id) > 0) { state.cart.set(id, (state.cart.get(id) ?? 0) + 1); renderCart(); renderProducts(); }
        }));
      }

      function validatePromo(code) {
        const c = String(code).trim().toUpperCase();
        if (!c) return { ok: false, msg: "Veuillez saisir un code." };
        const entry = CONFIG.whaleKeys[c];
        if (!entry) return { ok: false, msg: "Code non reconnu." };
        if (Date.now() >= entry.expiresAt) return { ok: false, msg: "Code expire." };
        return { ok: true, msg: `Remise de ${money(entry.discount)} appliquee.`, ...entry, code: c };
      }

      $("applyPromoBtn").addEventListener("click", () => {
        const res = validatePromo($("promoCode").value);
        if (!res.ok) { setError(res.msg); state.promo = { valid: false }; } else { setError(""); state.promo = { valid: true, discount: res.discount, expiresAt: res.expiresAt, code: res.code }; }
        updateTotalsUI();
      });

      els.clearCart.addEventListener("click", () => { state.cart.clear(); renderCart(); renderProducts(); updateTotalsUI(); setError(""); });

      ["input","change"].forEach(evt => {
        els.name.addEventListener(evt, () => { setError(""); updateTotalsUI(); });
        els.contact.addEventListener(evt, () => { setError(""); updateTotalsUI(); });
        els.location.addEventListener(evt, () => { setError(""); updateTotalsUI(); });
        els.allergyCheck.addEventListener(evt, () => { setError(""); updateTotalsUI(); });
      });

      function buildReceiptData() {
        const subtotal = calcSubtotal(), discount = calcDiscount(subtotal), fee = calcDeliveryFee();
        const total = Math.max(0, subtotal - discount) + fee;
        const items = Array.from(state.cart.entries()).map(([id, qty]) => {
          return { id, nom: CATALOGUE.find(x => x.id === id).name, quantite: qty, total_ligne: Number(((CONFIG.prices[id] ?? 0) * qty).toFixed(2)) };
        });
        const now = new Date();
        const receiptId = `BP-${now.getFullYear()}${String(now.getMonth()+1).padStart(2,"0")}${String(now.getDate()).padStart(2,"0")}-${now.getTime()}`;
        return { receiptId, client: { nom: els.name.value, contact: els.contact.value, lieu: els.location.value }, items, pricing: { sous_total: subtotal, remise: discount, frais: fee, total }, timestamp: now.toISOString(), allergyConfirm: els.allergyCheck.checked };
      }

      async function postJson(url, data) {
        await fetch(url, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) });
      }

      function showReceipt(data) {
        els.receiptId.textContent = data.receiptId;
        $("rName").textContent = data.client.nom;
        $("rContact").textContent = data.client.contact;
        $("rLocation").textContent = data.client.lieu;
        $("rItems").innerHTML = "";
        data.items.forEach(it => {
          const li = document.createElement("li");
          li.textContent = `${it.nom} x${it.quantite} | ${money(it.total_ligne)}`;
          $("rItems").appendChild(li);
        });
        $("rTotal").textContent = money(data.pricing.total);
        $("rTime").textContent = data.timestamp;
        $(".orderForm").classList.add("hidden");
        $("receipt").classList.remove("hidden");
      }

      els.orderForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const receipt = buildReceiptData();
        await postJson(CONFIG.endpoints.formspree, receipt);
        await postJson(CONFIG.endpoints.discordWebhook, { content: JSON.stringify(receipt,null,2) });
        showReceipt(receipt);
      });

      renderProducts();
      renderCart();
      updateTotalsUI();
    </script>
  </body>
</html>
